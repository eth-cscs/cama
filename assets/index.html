<!doctype html>
<html>
    <head>
        <link rel="stylesheet" href="node_modules/xterm/css/xterm.css" />
        <script src="node_modules/xterm/lib/xterm.js"></script>
        <script src="node_modules/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
    </head>
    <body>
        <div id="terminal"></div>
        <script>
            const socket = new WebSocket("ws://localhost:3000/ws");
            const term = new Terminal({cursorBlink: true, convertEol: true});
            const fitAddon = new FitAddon.FitAddon(); // hack https://github.com/xtermjs/xterm.js/issues/2499#issuecomment-622529801
            term.loadAddon(fitAddon);
            term.open(document.getElementById('terminal'));
            fitAddon.fit();
            term.write('Hello from \x1B[1;3;31mCAMA!!!\x1B[0m $ ');

            function init() {
                if (term._intialized) {
                    return;
                }

                term._initialized = true;
                term.prompt = () => {
                    term.write('\r\n$ ');
                };
                prompt(term);

                term.onData(e => {
                    switch (e) {
                        case '\u0003': // Ctrl+C
                            term.write('^C');
                            prompt(term);
                            break;
                        case '\r': // Enter
                            runCommand(term, command);
                            command = '';
                            break;
                        case '\u007F': // Backspace (DEL)
                            // Do not delete the prompt
                            if (term._core.buffer.x > 2) {
                                term.write('\b \b');
                                if (command.length > 0) {
                                    command = command.substr(0, command.length - 1);
                                }
                            }
                            break;
                        case '\u0009':
                            console.log('tabbed', output, ["dd", "ls"]);
                            break;
                        default:
                            if (e >= String.fromCharCode(0x20) && e <= String.fromCharCode(0x7E) || e >= '\u00a0') {
                                command += e;
                                term.write(e);
                            }
                    }
                });
            }

            function clearInput(command) {
                var inputLengh = command.length;
                for (var i = 0; i < inputLengh; i++) {
                    term.write('\b \b');
                }
            }

            function prompt(term) {
                command = '';
                term.write('\r\n$ ');
            }

            socket.onmessage = (event) => {
                term.write(event.data);
            }

            function runCommand(term, command) {
                // if (command.length > 0) {
                    clearInput(command);
                    socket.send(command + '\n');
                    return;
                    // }
            }

            init();
        </script>
    </body>
</html>

